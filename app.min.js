document.addEventListener("DOMContentLoaded",function(){const SYSTEM_VERSION="v1.0.3";const ADMIN_PASSWORD="3787";const namesInput=document.getElementById("namesInput");const tasksInput=document.getElementById("tasksInput");const tasksCountLabel=document.getElementById("tasksCount");const shuffleBtn=document.getElementById("shuffleNames");const randomBtn=document.getElementById("randomAssign");const resetBtn=document.getElementById("resetForm");const exportPngBtn=document.getElementById("exportPng");const exportPdfBtn=document.getElementById("exportPdf");const exportArea=document.getElementById("exportArea");const themeToggleBtn=document.getElementById("themeToggle");const errorBox=document.getElementById("errorBox");const resultBody=document.getElementById("resultBody");const summaryBox=document.getElementById("summaryBox");const dashboardBox=document.getElementById("dashboardBox");const namesCard=document.getElementById("namesCard");const titleInput=document.getElementById("titleInput");const dateInput=document.getElementById("dateInput");const hourInput=document.getElementById("hourInput");const minuteInput=document.getElementById("minuteInput");const displayTitle=document.getElementById("displayTitle");const displayDate=document.getElementById("displayDate");const displayTime=document.getElementById("displayTime");const displayVersion=document.getElementById("displayVersion");const versionFooter=document.getElementById("versionFooter");const adminLogOverlay=document.getElementById("adminLogOverlay");const closeLogOverlayBtn=document.getElementById("closeLogOverlay");const logList=document.getElementById("logList");const clearLogBtn=document.getElementById("clearLog");const logDateFromInput=document.getElementById("logDateFrom");const logDateToInput=document.getElementById("logDateTo");const logSearchInput=document.getElementById("logSearch");const applyLogFilterBtn=document.getElementById("applyLogFilter");const clearLogFilterBtn=document.getElementById("clearLogFilter");const downloadCsvBtn=document.getElementById("downloadCsv");if(displayVersion)displayVersion.textContent=SYSTEM_VERSION;if(versionFooter)versionFooter.textContent=SYSTEM_VERSION;const defaultNamesText=namesInput.value.trim();function populateTimeSelects(){hourInput.innerHTML='<option value="">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>';for(let h=0;h<24;h++){const hh=String(h).padStart(2,"0");const opt=document.createElement("option");opt.value=hh;opt.textContent=hh;hourInput.appendChild(opt)}minuteInput.innerHTML='<option value="">‡∏ô‡∏≤‡∏ó‡∏µ</option>';for(let m=0;m<60;m++){const mm=String(m).padStart(2,"0");const opt=document.createElement("option");opt.value=mm;opt.textContent=mm;minuteInput.appendChild(opt)}}function buildExportFilename(){const now=new Date;const pad=n=>String(n).padStart(2,"0");const dd=pad(now.getDate());const mm=pad(now.getMonth()+1);const yyyy=now.getFullYear();const hh=pad(now.getHours());const mi=pad(now.getMinutes());const ss=pad(now.getSeconds());return`task-randomizer_${dd}${mm}${yyyy}_${hh}${mi}${ss}`}function formatDisplayDate(iso){if(!iso)return"-";const parts=iso.split("-");if(parts.length!==3)return iso;const y=parseInt(parts[0],10);const m=parseInt(parts[1],10);const d=parseInt(parts[2],10);if(isNaN(y)||isNaN(m)||isNaN(d))return iso;const date=new Date(y,m-1,d);const thaiDays=["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå"];const thaiMonths=["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô","‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];const dayName=thaiDays[date.getDay()];const monthName=thaiMonths[m-1]||parts[1];const beYear=y+543;return`‡∏ß‡∏±‡∏ô${dayName} ‡∏ó‡∏µ‡πà ${d} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô${monthName} ‡∏û.‡∏®.${beYear}`}function formatDisplayTime(time){if(!time)return"-";const parts=time.split(":");if(parts.length<2)return time;const[h,m]=parts;return`${h}:${m} ‡∏ô.`}function applyTheme(theme){const isDark=theme==="dark";document.documentElement.setAttribute("data-theme",isDark?"dark":"light");themeToggleBtn.textContent=isDark?"üåô Dark mode":"üåû Light mode"}const savedTheme=localStorage.getItem("taskTheme");applyTheme(savedTheme==="dark"?"dark":"light");themeToggleBtn.addEventListener("click",function(){const current=document.documentElement.getAttribute("data-theme")||"light";const next=current==="light"?"dark":"light";applyTheme(next);localStorage.setItem("taskTheme",next);addLog("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°",`‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏´‡∏°‡πà: ${next==="dark"?"Dark":"Light"}`)});function parseNames(text){return text.split(/[\n,]/).map(n=>n.trim()).filter(n=>n.length>0)}function parseTasks(text){return text.split(/[\s,]+/).map(t=>t.trim()).filter(t=>t.length>0)}function findDuplicates(arr){const count={};const dups=new Set;arr.forEach(item=>{count[item]=(count[item]||0)+1;if(count[item]>1)dups.add(item)});return Array.from(dups)}function shuffle(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]]}return array}function showError(message){errorBox.innerHTML=message;errorBox.style.display="block"}function clearError(){errorBox.innerHTML="";errorBox.style.display="none"}function updateTaskCount(){const tasks=parseTasks(tasksInput.value);tasksCountLabel.textContent="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ã‡∏ô: "+tasks.length}function hasResult(){return resultBody.children.length>0}function getDuplicateMessagesFromInputs(){const names=parseNames(namesInput.value);const tasks=parseTasks(tasksInput.value);const messages=[];const nameDups=findDuplicates(names);const taskDups=findDuplicates(tasks);if(nameDups.length>0){messages.push("‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥: "+nameDups.join(", "))}if(taskDups.length>0){messages.push("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ã‡∏ô‡∏ã‡πâ‡∏≥: "+taskDups.join(", "))}return messages}function liveValidateDuplicates(){const messages=getDuplicateMessagesFromInputs();if(messages.length>0){showError(messages.join("<br>"))}else{clearError()}}const LOG_KEY="taskRandomizerLogs_v1";let logs=[];let logFilter={from:"",to:"",search:""};function formatLogTimestamp(iso){try{const d=new Date(iso);if(isNaN(d.getTime()))throw new Error;const pad=n=>String(n).padStart(2,"0");const dd=pad(d.getDate());const mm=pad(d.getMonth()+1);const yyyy=d.getFullYear()+543;const hh=pad(d.getHours());const mi=pad(d.getMinutes());const ss=pad(d.getSeconds());return`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dd}/${mm}/${yyyy} ‡πÄ‡∏ß‡∏•‡∏≤ ${hh}:${mi}:${ss} ‡∏ô.`}catch(e){return iso||""}}function getFilteredLogs(){if(!logs)return[];return logs.filter(entry=>{const ts=new Date(entry.ts);if(logFilter.from){const fromDate=new Date(logFilter.from+"T00:00:00");if(ts<fromDate)return false}if(logFilter.to){const toDate=new Date(logFilter.to+"T23:59:59");if(ts>toDate)return false}if(logFilter.search){const q=logFilter.search.toLowerCase();const text=((entry.action||"")+" "+(entry.detail||"")).toLowerCase();if(!text.includes(q))return false}return true})}function renderLogs(){if(!logList)return;const filtered=getFilteredLogs();if(!filtered||filtered.length===0){logList.innerHTML='<div class="log-empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>';return}logList.innerHTML=filtered.map(entry=>`<div class="log-item"><div class="log-ts">${formatLogTimestamp(entry.ts)}</div><div class="log-action">${entry.action}</div>${entry.detail?`<div class="log-detail">${entry.detail}</div>`:""}</div>`).join("")}function saveLogs(){try{localStorage.setItem(LOG_KEY,JSON.stringify(logs))}catch(e){}}function addLog(action,detail){logs.unshift({ts:new Date().toISOString(),action:action,detail:detail||""});if(logs.length>200){logs.length=200}saveLogs();renderLogs()}function loadLogs(){try{const raw=localStorage.getItem(LOG_KEY);logs=raw?JSON.parse(raw):[]}catch(e){logs=[]}renderLogs()}if(clearLogBtn){clearLogBtn.addEventListener("click",function(){if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?"))return;logs=[];saveLogs();renderLogs()})}if(applyLogFilterBtn){applyLogFilterBtn.addEventListener("click",()=>{logFilter.from=logDateFromInput.value;logFilter.to=logDateToInput.value;logFilter.search=logSearchInput.value.trim();renderLogs()})}if(clearLogFilterBtn){clearLogFilterBtn.addEventListener("click",()=>{logFilter={from:"",to:"",search:""};if(logDateFromInput)logDateFromInput.value="";if(logDateToInput)logDateToInput.value="";if(logSearchInput)logSearchInput.value="";renderLogs()})}if(downloadCsvBtn){downloadCsvBtn.addEventListener("click",()=>{const data=getFilteredLogs();if(!data||data.length===0){alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• log ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");return}const header=["timestamp_iso","timestamp_th","action","detail"];const rows=data.map(entry=>{const iso=entry.ts||"";const th=formatLogTimestamp(entry.ts||"");const action=(entry.action||"").replace(/"/g,'""');const detail=(entry.detail||"").replace(/"/g,'""');return`"${iso}","${th}","${action}","${detail}"`});const csv="\uFEFF"+header.join(",")+"\n"+rows.join("\n");const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="task-randomizer-logs.csv";document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);addLog("‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV log",`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß ${data.length}`)})}function openAdminLog(){adminLogOverlay.classList.add("show");renderLogs()}function closeAdminLog(){adminLogOverlay.classList.remove("show")}function requestAdminPassword(){const input=prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin Log:");if(input===null)return;if(input===ADMIN_PASSWORD){openAdminLog();addLog("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Admin Log","‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")}else{alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");addLog("‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Admin Log","‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")}}if(closeLogOverlayBtn){closeLogOverlayBtn.addEventListener("click",closeAdminLog)}if(versionFooter){versionFooter.style.cursor="default";versionFooter.addEventListener("dblclick",requestAdminPassword)}document.addEventListener("keydown",e=>{if(e.key==="Escape"&&adminLogOverlay.classList.contains("show")){closeAdminLog()}});namesInput.addEventListener("input",function(){liveValidateDuplicates()});namesInput.addEventListener("blur",function(){const names=parseNames(namesInput.value);if(names.length>0){addLog("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô",`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ${names.length} ‡∏Ñ‡∏ô`)}});tasksInput.addEventListener("input",function(){const pos=tasksInput.selectionStart;const original=tasksInput.value;const upper=original.toUpperCase();if(original!==upper){tasksInput.value=upper;tasksInput.setSelectionRange(pos,pos)}liveValidateDuplicates();updateTaskCount()});tasksInput.addEventListener("blur",function(){const tasks=parseTasks(tasksInput.value);if(tasks.length>0){addLog("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô",`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ${tasks.length} ‡∏á‡∏≤‡∏ô`)}});shuffleBtn.addEventListener("click",function(){const names=parseNames(namesInput.value);if(names.length===0){showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö");return}clearError();const shuffled=shuffle([...names]);namesInput.value=shuffled.join("\n");liveValidateDuplicates();namesCard.classList.remove("card-wow");void namesCard.offsetWidth;namesCard.classList.add("card-wow");dashboardBox.classList.remove("dashboard-chart-wow");void dashboardBox.offsetWidth;dashboardBox.classList.add("dashboard-chart-wow");addLog("‡∏™‡∏•‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠",`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô ${shuffled.length} ‡∏Ñ‡∏ô`)});resetBtn.addEventListener("click",function(){namesInput.value=defaultNamesText;tasksInput.value="";titleInput.value="";const d=new Date,y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),da=String(d.getDate()).padStart(2,"0");dateInput.value=y+"-"+m+"-"+da;hourInput.value="";minuteInput.value="";resultBody.innerHTML="";summaryBox.innerHTML="";dashboardBox.innerHTML="";displayTitle.textContent="-";displayDate.textContent="-";displayTime.textContent="-";clearError();liveValidateDuplicates();updateTaskCount();addLog("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°","‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô")});randomBtn.addEventListener("click",function(){clearError();resultBody.innerHTML="";summaryBox.innerHTML="";dashboardBox.innerHTML="";const names=parseNames(namesInput.value);const tasks=parseTasks(tasksInput.value);if(names.length<1){showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô");return}if(tasks.length<1){showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ã‡∏ô ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÇ‡∏ã‡∏ô");return}const title=titleInput.value.trim();const dateValue=dateInput.value;const hourVal=hourInput.value;const minuteVal=minuteInput.value;if(!title||!dateValue||!hourVal||!minuteVal){showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö: ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô (24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)");return}const dupMessages=getDuplicateMessagesFromInputs();if(dupMessages.length>0){showError(dupMessages.join("<br>"));return}const normalizedTime=`${hourVal}:${minuteVal}`;displayTitle.textContent=title;displayDate.textContent=formatDisplayDate(dateValue);displayTime.textContent=formatDisplayTime(normalizedTime);const assignments=assignRandom(names,tasks);renderResult(assignments,tasks.length);renderDashboard(assignments,tasks.length);addLog("‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏ö‡πà‡∏á‡∏á‡∏≤‡∏ô",`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô ${names.length} ‡∏Ñ‡∏ô, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô ${tasks.length} ‡∏á‡∏≤‡∏ô`)});function assignRandom(names,tasks){const result=names.map(n=>({name:n,tasks:[]}));const taskPool=shuffle([...tasks]);const order=shuffle([...Array(names.length).keys()]);for(const idx of order){if(taskPool.length===0)break;result[idx].tasks.push(taskPool.pop())}while(taskPool.length>0){const idx=Math.floor(Math.random()*names.length);result[idx].tasks.push(taskPool.pop())}return result}function renderResult(assignments,totalTasks){let index=1;assignments.forEach(entry=>{const tr=document.createElement("tr");tr.classList.add("result-table-row");const delaySec=((index-1)*.04).toFixed(2);tr.style.setProperty("--row-delay",delaySec+"s");const tdIndex=document.createElement("td");tdIndex.textContent=index++;tr.appendChild(tdIndex);const tdName=document.createElement("td");tdName.textContent=entry.name;tdName.classList.add("name-cell");tr.appendChild(tdName);const tdTasks=document.createElement("td");tdTasks.textContent=entry.tasks.join(", ");tdTasks.classList.add("tasks-cell");tr.appendChild(tdTasks);const tdCount=document.createElement("td");tdCount.classList.add("count-cell");const pill=document.createElement("span");const count=entry.tasks.length;pill.textContent=count;pill.classList.add("pill");if(count>=7){pill.classList.add("pill-high","blink-pink")}else if(count>=3){pill.classList.add("pill-mid","blink-blue")}else{pill.classList.add("pill-low","blink-orange")}tdCount.appendChild(pill);tr.appendChild(tdCount);resultBody.appendChild(tr)});const totalPeople=assignments.length;const avg=(totalTasks/totalPeople).toFixed(2);summaryBox.innerHTML=`<div class="chip">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong>${totalPeople}</strong></div><div class="chip">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong>${totalTasks}</strong></div><div class="chip">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô: <strong>${avg}</strong></div>`}function renderDashboard(assignments,totalTasks){const counts=assignments.map(a=>a.tasks.length);const totalPeople=assignments.length;const maxCount=Math.max(...counts,1);const minCount=Math.min(...counts);const avg=(totalTasks/totalPeople).toFixed(2);const maxWorkers=assignments.filter(a=>a.tasks.length===maxCount).map(a=>a.name);const minWorkers=assignments.filter(a=>a.tasks.length===minCount).map(a=>a.name);const over7=assignments.filter(a=>a.tasks.length>=7).length;const barsHtml=assignments.map((entry,index)=>{const count=entry.tasks.length;const ratio=maxCount===0?0:count/maxCount;const width=count===0?0:Math.max(ratio*100,10);let barClass="bar-fill-mid";if(count>=7)barClass="bar-fill-high";else if(count>=3)barClass="bar-fill-mid";else barClass="bar-fill-low";const delay=(index*.05).toFixed(2);return`<div class="bar-row" style="--delay:${delay}s;"><div class="bar-name">${entry.name}</div><div class="bar-track"><div class="bar-fill ${barClass}" style="width:${width}%;"></div></div><div class="bar-count">${count}</div></div>`}).join("");dashboardBox.classList.remove("dashboard-wow");void dashboardBox.offsetWidth;dashboardBox.classList.add("dashboard-wow");dashboardBox.innerHTML=`<h3 class="dashboard-title">Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏á‡∏≤‡∏ô<span>(‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô)</span></h3><div class="dash-grid"><div class="dash-card"><div class="dash-label">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="dash-value">${totalTasks}</div><div class="dash-sub">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${avg} ‡∏á‡∏≤‡∏ô / ‡∏Ñ‡∏ô</div></div><div class="dash-card"><div class="dash-label">‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div><div class="dash-value">${maxCount}</div><div class="dash-sub">‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà: ${maxWorkers.join(", ")||"-"}</div></div><div class="dash-card"><div class="dash-label">‡∏á‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div><div class="dash-value">${minCount}</div><div class="dash-sub">‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà: ${minWorkers.join(", ")||"-"}</div></div><div class="dash-card"><div class="dash-label">‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏á‡∏≤‡∏ô ‚â• 7 ‡∏á‡∏≤‡∏ô</div><div class="dash-value">${over7}</div><div class="dash-sub">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏Å‡∏™‡∏∏‡∏î</div></div></div><div class="dash-legend"><span class="legend-item"><span class="legend-color legend-low"></span> ‚â§ 2 ‡∏á‡∏≤‡∏ô (‡∏™‡πâ‡∏°)</span><span class="legend-item"><span class="legend-color legend-mid"></span> 3‚Äì6 ‡∏á‡∏≤‡∏ô (‡∏ü‡πâ‡∏≤)</span><span class="legend-item"><span class="legend-color legend-high"></span> ‚â• 7 ‡∏á‡∏≤‡∏ô (‡∏ä‡∏°‡∏û‡∏π)</span></div><div class="bar-list">${barsHtml}</div>`}async function captureExportArea(){if(!hasResult()){showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏ö‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");return null}clearError();const prevTheme=document.documentElement.getAttribute("data-theme")||"light";document.documentElement.setAttribute("data-theme","light");exportArea.classList.add("export-capture");try{const canvas=await html2canvas(exportArea,{scale:2,backgroundColor:"#ffffff",scrollY:-window.scrollY});return canvas}catch(err){console.error(err);showError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");return null}finally{exportArea.classList.remove("export-capture");document.documentElement.setAttribute("data-theme",prevTheme)}}exportPngBtn.addEventListener("click",async()=>{const canvas=await captureExportArea();if(!canvas)return;const filename=buildExportFilename();const link=document.createElement("a");link.download=filename+".png";link.href=canvas.toDataURL("image/png");link.click();addLog("Export PNG",`‡πÑ‡∏ü‡∏•‡πå: ${filename}.png`)});exportPdfBtn.addEventListener("click",async()=>{if(!window.jspdf||!window.jspdf.jsPDF){showError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£ Export PDF ‡πÑ‡∏î‡πâ (jsPDF ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)");return}const canvas=await captureExportArea();if(!canvas)return;const filename=buildExportFilename();const imgData=canvas.toDataURL("image/png");const pdf=new window.jspdf.jsPDF("p","mm","a4");const pageWidth=pdf.internal.pageSize.getWidth();const pageHeight=pdf.internal.pageSize.getHeight();const margin=10;const availableWidth=pageWidth-margin*2;const availableHeight=pageHeight-margin*2;const ratio=Math.min(availableWidth/canvas.width,availableHeight/canvas.height);const imgWidth=canvas.width*ratio;const imgHeight=canvas.height*ratio;const x=(pageWidth-imgWidth)/2;const y=margin;pdf.addImage(imgData,"PNG",x,y,imgWidth,imgHeight);pdf.save(filename+".pdf");addLog("Export PDF",`‡πÑ‡∏ü‡∏•‡πå: ${filename}.pdf`)});populateTimeSelects();if(dateInput){const d=new Date,y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),da=String(d.getDate()).padStart(2,"0");dateInput.value=y+"-"+m+"-"+da}updateTaskCount();loadLogs()});